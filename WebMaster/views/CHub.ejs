<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resources</title>
    <link rel="stylesheet" href="/css/chub.css">
</head>

<body>
    <div id="navlinks">
        <h2 id="chubttl">C-HUB.</h2>  
        <div id="btns">
            <a id="referencePage" href="/reference">Reference Page</a>
            <a id="home" href="/">Home</a>
        <a id="forum" href="/forum">Create +</a>
        </div>
    </div>
    <div id="resourceCont">

        <header>
            <h1>Community Resources</h1>
        </header>
        <hr>
        <section>
            <h2>Submit a Resource</h2>
            <p>To share a resource with the community, go to the <a id="forumlink"
                    href="/forum"><strong>Forum</strong></a>
                and submit it there.
                All approved resources appear on this Resource Hub.</p><br>
        </section>

        <section>
            <div id="rtbanner">
                <h2>All Resources</h2>
                <input type="text" id="searchbar" onkeyup="searchResources()" placeholder="Search...">
            </div>
            <% if (resources && resources.length) { %>
                <ul>
                    <% resources.forEach(function(r){ %>
                        <li>
                            <strong id="titletxt">
                                <%= r.title %>
                                <% if (Number(r.verified)) { %>
                                    <span class="verified" title="Verified">&#10003;</span>
                                <% } %>
                            </strong>
                            <div id="time"><%= new Date(r.created_at).toLocaleString() %></div>
                            <hr style="width: 65%; margin-left: 0; margin-top: 5px; margin-bottom: 5px; height: 4px; background-color: #ffffff; border: none;">
                            <p>
                                <%= r.description || '' %>
                            </p>
                            <a id="titleref" href="<%= r.url %>" target="_blank" rel="noopener noreferrer" onclick="return verifyCheck(<%= Number(r.verified) %>);"><strong>
                                    Go There!
                                </strong></a>

                            <!-- input box at bottom-right of each resource -->
                            <input class="box-input" data-id="<%= r.id %>" type="text" placeholder="insert code to edit" />
                        </li>
                    <% }) %>
                    </ul>
                    <% } else { %>
                        <p>No resources yet â€” be the first to add one!</p>
                    <% } %>
        </section>
                    
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    function verifyCheck(isVerified) {
        if (!isVerified) {
            const proceed = confirm("This resource has not been verified. Are you sure you want to proceed?");
            return proceed; // If true, navigation continues; if false, navigation is prevented.
        }
        return true; // If verified, allow navigation.
        }


    function searchResources() {
        const input = document.getElementById('searchbar');
        const filter = input.value.toLowerCase();
        const ul = document.querySelector('#resourceCont ul');
        if (!ul) return;
        const li = ul.getElementsByTagName('li');

        for (let i = 0; i < li.length; i++) {
            const title = li[i].getElementsByTagName('strong')[0];
            const description = li[i].getElementsByTagName('p')[0];
            const titleText = title ? (title.textContent || title.innerText) : '';
            const descriptionText = description ? (description.textContent || description.innerText) : '';

            if (titleText.toLowerCase().indexOf(filter) > -1 || descriptionText.toLowerCase().indexOf(filter) > -1) {
                li[i].style.display = '';
            } else {
                li[i].style.display = 'none';
            }
        }
    }

    //html escape function bc socket lowkey kinda sucks tbh
    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Connect to socket.io server ðŸ˜«
    const socket = io();

    // When a new resource is added by someone, append it to the list yay!
    socket.on('resource_added', (r) => {
        // find or create the list container
        let ul = document.querySelector('#resourceCont ul');
        if (!ul) {
            const noResP = document.querySelector('#resourceCont section:nth-of-type(2) p');
            if (noResP) noResP.remove();
            const section = document.querySelector('#resourceCont section:nth-of-type(2)');
            ul = document.createElement('ul');
            section.appendChild(ul);
        }

        const li = document.createElement('li');
        li.innerHTML = '<strong id="titletxt">' + escapeHtml(r.title) + (r.verified ? ' <span class="verified" title="Verified">&#10003;</span>' : '') + '</strong>' +
            '<div id="time">' + new Date(r.created_at).toLocaleString() + '</div>' +
            '<hr style="width: 65% ; margin-left: 0; margin-top: 5px; margin-bottom: 5px; height: 4px; background-color: #ffffff; border: none;">' +
            '<p>' + escapeHtml(r.description || '') + '</p>' +
            '<a id="titleref" href="' + escapeHtml(r.url) + '" target="_blank" rel="noopener noreferrer" onclick="return verifyCheck(' + Number(r.verified) + ');"><strong>Go There!</strong></a>' +
            '<input class="box-input" data-id="' + escapeHtml(r.id) + '" type="text" placeholder="insert code to edit" />';

        ul.insertBefore(li, ul.firstChild);

        searchResources();
    });

    // verify input value with server; open edit/admin page if match
    function verifyAndOpen(id, code, inputEl) {
        const idNum = parseInt(id, 10);
        if (Number.isNaN(idNum) || !code) {
            inputEl.style.borderColor = 'red';
            setTimeout(() => inputEl.style.borderColor = '', 1200);
            return;
        }
        console.log('verify: sending', { idNum, code });
        fetch('/verify-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: idNum, code: code })
        })
        .then(r => r.json())
        .then(j => {
            console.log('verify: response', j);
            if (j.ok) {
                if (j.admin) {
                    window.location.href = '/admin/' + encodeURIComponent(code) + '/' + idNum;
                } else {
                    window.location.href = '/edit/' + idNum;
                }
            } else {
                console.warn('verify: rejected code');
                inputEl.style.borderColor = 'red';
                setTimeout(() => inputEl.style.borderColor = '', 1200);
            }
        })
        .catch(() => {
            console.error('verify: error', err);
            inputEl.style.borderColor = 'red';
        });
    }

    // attach auto-verify handlers to each code input (debounced, no Enter needed)
    function attachInputHandlers() {
        const timers = new WeakMap();
        document.querySelectorAll('.box-input').forEach(inp => {
            if (inp._wired) return;
            inp._wired = true;
            const trigger = () => {
                const id = inp.dataset.id;
                const code = inp.value.trim();
                if (!code) return; // wait for some input
                if (timers.has(inp)) clearTimeout(timers.get(inp));
                const t = setTimeout(() => verifyAndOpen(id, code, inp), 250);
                timers.set(inp, t);
            };
            console.log('verify: wiring input for id', inp.dataset.id);
            inp.addEventListener('input', trigger);
            inp.addEventListener('blur', trigger);
        });
    }

    // ensure handlers after DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachInputHandlers);
    } else {
        attachInputHandlers();
    }

    socket.on('resource_added', () => {
        attachInputHandlers();
    });
    </script>
</body>
</html>